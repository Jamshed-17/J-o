### 1. Преимущества хранимых процедур

- **Производительность:** Процедуры компилируются один раз и хранятся на сервере в виде исполняемого кода.
    
- **Снижение трафика:** Вместо передачи длинных SQL-запросов клиент отправляет только имя процедуры и параметры.
    
- **Безопасность:** Можно дать пользователю права на запуск процедуры, не давая прямого доступа к таблицам.
    
- **Централизация логики:** Изменения в коде вносятся на сервере, а не в каждом клиентском приложении.
    

### 2. Преимущества триггеров

- **Автоматизация:** Срабатывают автоматически при событиях DML (INSERT, UPDATE, DELETE).
    
- **Целостность данных:** Позволяют реализовать сложные проверки, которые невозможно описать через CHECK.
    
- **Аудит:** Удобны для ведения логов изменений (кто, когда и что изменил).
    
- **Синхронизация:** Автоматическое обновление связанных данных в других таблицах.
    

### 3. Объявление локальной переменной

В теле модуля (процедуры или триггера) переменные объявляются с помощью ключевого слова `DECLARE VARIABLE` перед основным блоком `BEGIN ... END`.

SQL

```
DECLARE VARIABLE MY_VAR INTEGER;
DECLARE VARIABLE TOTAL_PRICE NUMERIC(15, 2) = 0; -- С инициализацией
```

### 4. Условные операторы в PSQL

1. **IF...THEN...ELSE:**
    
    SQL
    
    ```
    IF (условие) THEN 
        /* действия */
    ELSE 
        /* действия */
    ```
    
2. **CASE:** Используется для выбора одного из нескольких значений.
    
3. **WHILE:** Цикл с предпроверкой условия.
    

### 5. Курсоры: явные и неявные

**Курсор** — это указатель на набор строк, возвращаемый запросом.

- **Неявный курсор:** Создается автоматически для одиночных запросов `SELECT ... INTO`. Если запрос вернет более одной строки, возникнет ошибка.
    
- **Явный курсор:** Объявляется пользователем (`DECLARE CURSOR`). Позволяет последовательно перебирать строки результата запроса с помощью команд `OPEN`, `FETCH` и `CLOSE`.
    

### 6. Использование RETURNING в PSQL

Чтобы запомнить значения столбцов сразу после вставки или изменения, используется конструкция `RETURNING ... INTO`:

SQL

```
INSERT INTO USERS (NAME) VALUES ('Admin') 
RETURNING ID INTO :NEW_ID;
```

### 7. Генератор последовательности (Sequence)

Это объект, генерирующий уникальные числа (обычно для первичных ключей).

- **Создание:** `CREATE SEQUENCE SEQ_NAME;`
    
- **Использование:** `NEXT VALUE FOR SEQ_NAME`
    
- **Удаление:** `DROP SEQUENCE SEQ_NAME;`
    

### 8. Исключения (Exceptions)

Механизм обработки ошибок.

- **Создание:** `CREATE EXCEPTION ERR_MSG 'Текст ошибки';`
    
- **Изменение:** `ALTER EXCEPTION ERR_MSG 'Новый текст';`
    
- **Вызов:** `EXCEPTION ERR_MSG;`
    
- **Перехват:** Блок `WHEN ANY DO` или `WHEN EXCEPTION ... DO` в конце модуля.
    

### 9. Динамическое выполнение запросов

Осуществляется с помощью оператора **`EXECUTE STATEMENT`**.

- **Формы:**
    
    1. Простое выполнение: `EXECUTE STATEMENT 'DROP TABLE TEMP_DATA';`
        
    2. С возвратом значений: `EXECUTE STATEMENT 'SELECT count(*) FROM ...' INTO :CNT;`
        
    3. С параметрами: использование `USING` для передачи переменных в строку запроса.
        

### 10. SQL-сценарии и создание БД

**SQL-сценарий** — это текстовый файл, содержащий последовательность команд SQL, разделенных терминатором (обычно `;` или `^`).

- **Создание БД:**
    
    SQL
    
    ```
    CREATE DATABASE 'C:\Data\Base.fdb' 
    USER 'SYSDBA' PASSWORD 'masterkey' 
    PAGE_SIZE 8192 DEFAULT CHARACTER SET UTF8;
    ```
    

### 11. DML-триггеры

Триггеры, реагирующие на изменение данных в таблицах.

- **Типы:** `BEFORE` (до операции) или `AFTER` (после).
    
- **События:** `INSERT`, `UPDATE`, `DELETE`.
    
- **Создание:**
    
    SQL
    
    ```
    CREATE TRIGGER TR_BI_TABLE FOR MY_TABLE
    ACTIVE BEFORE INSERT POSITION 0
    AS
    BEGIN
        IF (NEW.ID IS NULL) THEN NEW.ID = NEXT VALUE FOR SEQ_ID;
    END
    ```
    
- **Модификация:** `ALTER TRIGGER` (можно включить/выключить `ACTIVE/INACTIVE`).
    
- **Удаление:** `DROP TRIGGER имя_триггера;`
    

---

Хотите, чтобы я подготовил для вас практический пример кода, который объединяет все эти элементы (например, процедуру с генератором, курсором и обработкой исключений)?